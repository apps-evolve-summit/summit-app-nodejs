<html><head><link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-icons/social-icons.html">

</head><body><dom-module id="push-activation">
  <template>
    <paper-icon-item on-tap="tapSubscribePush">
      <iron-icon id="subscribeButton" icon="social:notifications" item-icon=""></iron-icon>
      Push Notifications
    </paper-icon-item>
  </template>

  <script>Polymer({is:"push-activation",publicServerKey:"BPOOvDThOUuSxiC-DuMv-WXG0XbSCwKR6Jux0CkyeyZ86OMF2U64VYKksNCJKoJdq1ISzYKfCUUxB6hKM0zeNGA",supportsPush:!1,ready:function(){if(!("serviceWorker"in navigator&&"PushManager"in window))return void console.error("Push notification NOT supported!");this.supportsPush=!0,console.log("Push notification supported!"),navigator.serviceWorker.getRegistration().then(this.initUI.bind(this)).catch(function(i){console.error("Service Worker not registered "+i)})},initUI:function(i){console.log("Service worker registered successfully!"),this.swRegistration=i,i.pushManager.getSubscription().then(function(i){return i?console.log("Subscription details: "+JSON.stringify(i)):console.log("User is not subscribed!"),null!==i}).then(this.updateSubscriptionButton.bind(this))},updateSubscriptionButton:function(i){var s=this.$.subscribeButton;this.isSubscribed=i,s.icon=i?"social:notifications-active":"social:notifications-off",s.disabled=!1},tapSubscribePush:function(i){console.log("#"),this.supportsPush&&(this.$.subscribeButton.disabled=!0,this.isSubscribed?this.unsubscribeUser():this.subscribeUser())},unsubscribeUser:function(){this.swRegistration.pushManager.getSubscription().then(function(i){return i&&i.unsubscribe(),i}).then(this.unregisterSubscriptionOnServer).then(function(){this.updateSubscriptionButton(!1),console.log("User successfully unsubscribed")}.bind(this)).catch(function(i){console.error("Cannot unsubscribe user ",i)})},unregisterSubscriptionOnServer:function(i){return fetch("/unregisterSubscription",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({subscription:i})})},subscribeUser:function(){this.swRegistration.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:this.urlB64ToUint8Array(this.publicServerKey)}).then(this.registerSubscriptionOnServer).then(function(){console.log("User successfully subscribed"),this.updateSubscriptionButton(!0)}.bind(this)).catch(function(i){console.log("Unable to subscribe user ",i)})},urlB64ToUint8Array:function(i){const s="=".repeat((4-i.length%4)%4),t=(i+s).replace(/\-/g,"+").replace(/_/g,"/"),e=window.atob(t),n=new Uint8Array(e.length);for(var r=0;r<e.length;++r)n[r]=e.charCodeAt(r);return n},registerSubscriptionOnServer:function(i){return fetch("/registerSubscription",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({subscription:i})})}});</script>
</dom-module>
</body></html>