<html><head><link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-icons/social-icons.html">

</head><body><dom-module id="push-activation">
  <template>
    <paper-icon-item on-tap="tapSubscribePush">
      <iron-icon id="subscribeButton" icon="social:notifications" item-icon=""></iron-icon>
      Push Notifications
    </paper-icon-item>
  </template>

  <script>Polymer({is:"push-activation",publicServerKey:"BPOOvDThOUuSxiC-DuMv-WXG0XbSCwKR6Jux0CkyeyZ86OMF2U64VYKksNCJKoJdq1ISzYKfCUUxB6hKM0zeNGA",supportsPush:!1,attached:function(){if(!("serviceWorker"in navigator&&"PushManager"in window))return void console.error("Push notification NOT supported!");this.supportsPush=!0,console.log("Push notification supported!"),this.getSwRegistration().then(this.initUI.bind(this))},getSwRegistration:function(){return this.swRegistration?Promise.resolve(this.swRegistration):navigator.serviceWorker.getRegistration().then(function(i){return i?(this.swRegistration=i,i):Promise.reject("No running service worker found!")}.bind(this))},initUI:function(i){i.pushManager.getSubscription().then(function(i){return i?console.log("Subscription details: "+JSON.stringify(i)):console.log("User is not subscribed!"),null!==i}).then(this.updateSubscriptionButton.bind(this))},updateSubscriptionButton:function(i){var t=this.$.subscribeButton;this.isSubscribed=i,t.icon=i?"social:notifications-active":"social:notifications-off",t.disabled=!1},tapSubscribePush:function(i){this.supportsPush&&this.getSwRegistration().then(function(){this.$.subscribeButton.disabled=!0,this.isSubscribed?this.unsubscribeUser():this.subscribeUser()}.bind(this))},unsubscribeUser:function(){this.swRegistration.pushManager.getSubscription().then(function(i){return i&&i.unsubscribe(),i}).then(this.unregisterSubscriptionOnServer).then(function(){this.updateSubscriptionButton(!1),console.log("User successfully unsubscribed")}.bind(this)).catch(function(i){console.error("Cannot unsubscribe user ",i)})},unregisterSubscriptionOnServer:function(i){return fetch("/unregisterSubscription",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({subscription:i})})},subscribeUser:function(){this.swRegistration.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:this.urlB64ToUint8Array(this.publicServerKey)}).then(this.registerSubscriptionOnServer).then(function(){console.log("User successfully subscribed"),this.updateSubscriptionButton(!0)}.bind(this)).catch(function(i){console.log("Unable to subscribe user ",i)})},urlB64ToUint8Array:function(i){const t="=".repeat((4-i.length%4)%4),s=(i+t).replace(/\-/g,"+").replace(/_/g,"/"),n=window.atob(s),e=new Uint8Array(n.length);for(var r=0;r<n.length;++r)e[r]=n.charCodeAt(r);return e},registerSubscriptionOnServer:function(i){return fetch("/registerSubscription",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({subscription:i})})}});</script>
</dom-module>
</body></html>